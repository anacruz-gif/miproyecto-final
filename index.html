<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Monitoreo Industrial - Banda y Ventiladores</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
    :root {
        --bg-dark: #0a0e1a;
        --bg-panel: #151b2e;
        --card-bg: #1a2332;
        --accent-banda: #fbbf24;
        --accent-vent: #22d3ee;
        --danger: #ef4444;
        --warning: #f59e0b;
        --success: #10b981;
        --text-main: #f8fafc;
        --border: #2d3748;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--bg-dark);
        font-family: 'Segoe UI', system-ui, sans-serif;
        color: var(--text-main);
        overflow-x: hidden;
    }

    /* Grid de fondo estilo industrial */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(34, 211, 238, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(34, 211, 238, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: 0;
        pointer-events: none;
    }

    header {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
        backdrop-filter: blur(15px);
        padding: 30px 25px;
        border-bottom: 3px solid var(--accent-banda);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 10;
    }

    .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    h1 {
        font-size: 1.8em;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 2px;
        background: linear-gradient(135deg, var(--accent-banda), var(--accent-vent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .authors {
        font-size: 0.85em;
        color: #94a3b8;
        margin-top: 5px;
    }

    .datetime-box {
        font-family: 'Courier New', monospace;
        color: var(--accent-vent);
        font-size: 1.3em;
        font-weight: bold;
        background: rgba(34, 211, 238, 0.1);
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid var(--accent-vent);
    }

    .container {
        padding: 30px 20px;
        max-width: 1400px;
        margin: auto;
        position: relative;
        z-index: 1;
    }

    .control-panel {
        text-align: center;
        margin-bottom: 30px;
        background: var(--bg-panel);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid var(--border);
    }

    .btn-connect {
        background: linear-gradient(135deg, var(--accent-banda), #f59e0b);
        color: #000;
        font-weight: bold;
        padding: 18px 45px;
        border-radius: 50px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(251, 191, 36, 0.4);
        font-size: 1.1em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-connect:hover { 
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(251, 191, 36, 0.6);
    }

    #status {
        margin-top: 15px;
        font-size: 1.1em;
        font-weight: 600;
    }

    .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .machine-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        border: 2px solid var(--border);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .machine-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, transparent, var(--accent-banda), transparent);
    }

    .machine-card.vent::before {
        background: linear-gradient(90deg, transparent, var(--accent-vent), transparent);
    }

    .machine-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    .alert-high {
        border-color: var(--danger) !important;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .card-title {
        font-size: 1.4em;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .status-badge {
        padding: 8px 18px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.85em;
        background: var(--success);
        color: #000;
        text-transform: uppercase;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
    }

    .metric-box {
        background: var(--bg-panel);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid var(--border);
        text-align: center;
    }

    .metric-label {
        font-size: 0.75em;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }

    .metric-value {
        font-size: 2em;
        font-weight: 800;
        font-family: 'Courier New', monospace;
    }

    .chart-container {
        position: relative;
        height: 250px;
        margin-top: 20px;
        background: var(--bg-dark);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--border);
    }

    .bottom-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }

    .analytics-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        border: 2px solid var(--border);
    }

    .log-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 25px;
        border: 2px solid var(--border);
    }

    .section-title {
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--accent-vent);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .log-list {
        height: 300px;
        overflow-y: auto;
        background: var(--bg-dark);
        padding: 15px;
        border-radius: 12px;
        list-style: none;
        border: 1px solid var(--border);
    }

    .log-list li {
        padding: 12px;
        margin-bottom: 8px;
        background: var(--bg-panel);
        border-radius: 8px;
        border-left: 4px solid var(--danger);
        font-size: 0.9em;
        font-family: 'Courier New', monospace;
    }

    .log-list::-webkit-scrollbar {
        width: 8px;
    }

    .log-list::-webkit-scrollbar-track {
        background: var(--bg-panel);
        border-radius: 10px;
    }

    .log-list::-webkit-scrollbar-thumb {
        background: var(--accent-vent);
        border-radius: 10px;
    }

    .btn-reset {
        margin-top: 15px;
        padding: 12px 30px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        text-transform: uppercase;
        transition: all 0.3s ease;
    }

    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .gauge-container {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
    }

    .gauge {
        position: relative;
        width: 150px;
        height: 150px;
    }

    .gauge canvas {
        width: 100% !important;
        height: 100% !important;
    }

    @media (max-width: 1200px) {
        .bottom-section {
            grid-template-columns: 1fr;
        }
        
        .dashboard {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>

<body>

<header>
    <div class="header-content">
        <div>
            <h1>‚öôÔ∏è SISTEMA DE PREDICCI√ìN DE FALLOS INDUSTRIALES</h1>
            <p class="authors"><b>Integrantes:</b> Ana Cruz, David Cunuhay, Walter Daquilema</p>
        </div>
        <div id="reloj" class="datetime-box">--:--:--</div>
    </div>
</header>

<div class="container">
    <div class="control-panel">
        <button class="btn-connect" onclick="connect()">üîå VINCULAR EQUIPOS INDUSTRIALES (BLE)</button>
        <p id="status">‚ö™ Esperando conexi√≥n con sistemas...</p>
    </div>

    <div class="dashboard">
        <!-- BANDA TRANSPORTADORA -->
        <div class="machine-card" id="card-g1">
            <div class="card-header">
                <h3 class="card-title" style="color:var(--accent-banda)">üè≠ BANDA TRANSPORTADORA</h3>
                <span class="status-badge" id="alert-g1">NORMAL</span>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-label">Actual</div>
                    <div class="metric-value" id="g1" style="color:var(--accent-banda)">0.00</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Pico</div>
                    <div class="metric-value" id="g1max" style="color:var(--warning)">0.00</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Promedio</div>
                    <div class="metric-value" id="g1avg" style="color:var(--success)">0.00</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="chart1"></canvas>
            </div>
        </div>

        <!-- VENTILADORES -->
        <div class="machine-card vent" id="card-g2">
            <div class="card-header">
                <h3 class="card-title" style="color:var(--accent-vent)">üí® SISTEMA DE VENTILADORES</h3>
                <span class="status-badge" id="alert-g2">NORMAL</span>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-label">Actual</div>
                    <div class="metric-value" id="g2" style="color:var(--accent-vent)">0.00</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Pico</div>
                    <div class="metric-value" id="g2max" style="color:var(--warning)">0.00</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Promedio</div>
                    <div class="metric-value" id="g2avg" style="color:var(--success)">0.00</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="chart2"></canvas>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="analytics-card">
            <h3 class="section-title">üìä AN√ÅLISIS COMPARATIVO</h3>
            <div class="chart-container" style="height: 350px;">
                <canvas id="chartComparison"></canvas>
            </div>
        </div>

        <div class="log-card">
            <h3 class="section-title">üìã HISTORIAL DE ALERTAS</h3>
            <ul id="historial" class="log-list"></ul>
            <button class="btn-reset" onclick="rearme()">üîÑ REARMAR SISTEMA</button>
        </div>
    </div>
</div>

<script>
let characteristic, rxCharacteristic;
let g1max=0, g2max=0, g1sum=0, g2sum=0, count=0;
let chart1, chart2, chartComparison;
const maxPoints = 30;

// Inicializar gr√°ficas
function initCharts() {
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: { 
                display: true,
                grid: { color: 'rgba(34, 211, 238, 0.1)' },
                ticks: { color: '#94a3b8' }
            },
            y: { 
                display: true,
                min: 0,
                max: 1.2,
                grid: { color: 'rgba(34, 211, 238, 0.1)' },
                ticks: { color: '#94a3b8' }
            }
        }
    };

    // Gr√°fica Banda
    chart1 = new Chart(document.getElementById('chart1'), {
        type: 'line',
        data: {
            labels: Array(maxPoints).fill(''),
            datasets: [{
                label: 'Vibraci√≥n Banda',
                data: Array(maxPoints).fill(0),
                borderColor: '#fbbf24',
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 0
            }]
        },
        options: commonOptions
    });

    // Gr√°fica Ventilador
    chart2 = new Chart(document.getElementById('chart2'), {
        type: 'line',
        data: {
            labels: Array(maxPoints).fill(''),
            datasets: [{
                label: 'Vibraci√≥n Ventilador',
                data: Array(maxPoints).fill(0),
                borderColor: '#22d3ee',
                backgroundColor: 'rgba(34, 211, 238, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 0
            }]
        },
        options: commonOptions
    });

    // Gr√°fica Comparativa
    chartComparison = new Chart(document.getElementById('chartComparison'), {
        type: 'line',
        data: {
            labels: Array(maxPoints).fill(''),
            datasets: [
                {
                    label: 'Banda',
                    data: Array(maxPoints).fill(0),
                    borderColor: '#fbbf24',
                    backgroundColor: 'rgba(251, 191, 36, 0.2)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Ventilador',
                    data: Array(maxPoints).fill(0),
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34, 211, 238, 0.2)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: '#f8fafc', font: { size: 14, weight: 'bold' } }
                }
            }
        }
    });
}

// RELOJ
setInterval(() => {
    const ahora = new Date();
    document.getElementById('reloj').innerText = 
        ahora.toLocaleDateString('es-ES') + " | " + ahora.toLocaleTimeString('es-ES');
}, 1000);

async function connect(){
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters:[{name:"ESP32_Vibracion"}],
            optionalServices:["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        characteristic = await service.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
        rxCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");

        characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleData);
        document.getElementById("status").innerText="üü¢ Conectado a Planta Industrial - Monitoreo Activo";
        
        if (!chart1) initCharts();
    } catch(e) { 
        console.log(e);
        document.getElementById("status").innerText="üî¥ Error de conexi√≥n";
    }
}

function handleData(e){
    const raw = new TextDecoder().decode(e.target.value);
    const p = raw.split(",");
    
    let g1 = parseFloat(p[0].split(":")[1]);
    let g2 = parseFloat(p[1].split(":")[1]);

    count++;
    g1sum += g1;
    g2sum += g2;

    if(g1 > g1max) g1max = g1;
    if(g2 > g2max) g2max = g2;

    let g1avg = g1sum / count;
    let g2avg = g2sum / count;

    // Actualizar valores
    document.getElementById("g1").textContent = g1.toFixed(2);
    document.getElementById("g2").textContent = g2.toFixed(2);
    document.getElementById("g1max").textContent = g1max.toFixed(2);
    document.getElementById("g2max").textContent = g2max.toFixed(2);
    document.getElementById("g1avg").textContent = g1avg.toFixed(2);
    document.getElementById("g2avg").textContent = g2avg.toFixed(2);

    // Alertas
    updateAlert("card-g1", "alert-g1", g1, 0.80, "FALLA CR√çTICA BANDA");
    updateAlert("card-g2", "alert-g2", g2, 0.45, "FALLA CR√çTICA VENTILADOR");

    // Actualizar gr√°ficas
    updateChart(chart1, g1);
    updateChart(chart2, g2);
    updateComparisonChart(g1, g2);
}

function updateChart(chart, value) {
    chart.data.datasets[0].data.push(value);
    if (chart.data.datasets[0].data.length > maxPoints) {
        chart.data.datasets[0].data.shift();
    }
    chart.update('none');
}

function updateComparisonChart(g1, g2) {
    chartComparison.data.datasets[0].data.push(g1);
    chartComparison.data.datasets[1].data.push(g2);
    
    if (chartComparison.data.datasets[0].data.length > maxPoints) {
        chartComparison.data.datasets[0].data.shift();
        chartComparison.data.datasets[1].data.shift();
    }
    chartComparison.update('none');
}

function updateAlert(cardId, badgeId, val, limit, msg){
    const card = document.getElementById(cardId);
    const badge = document.getElementById(badgeId);
    if(val > limit) {
        card.classList.add("alert-high");
        badge.innerText = "üö® CR√çTICO";
        badge.style.background = "#ef4444";
        addHist(msg);
    } else {
        card.classList.remove("alert-high");
        badge.innerText = "NORMAL";
        badge.style.background = "#10b981";
    }
}

function addHist(msg){
    const time = new Date().toLocaleTimeString('es-ES');
    const entry = `<li>‚ö†Ô∏è ${time} - ${msg}</li>`;
    const histEl = document.getElementById("historial");
    if(!histEl.innerHTML.includes(msg + "</li>")) {
        histEl.insertAdjacentHTML('afterbegin', entry);
    }
}

function rearme(){
    if(rxCharacteristic) rxCharacteristic.writeValue(new TextEncoder().encode("REARME"));
    g1max = 0; 
    g2max = 0;
    g1sum = 0;
    g2sum = 0;
    count = 0;
    document.getElementById("historial").innerHTML = "";
    
    // Reiniciar gr√°ficas
    if(chart1) {
        chart1.data.datasets[0].data = Array(maxPoints).fill(0);
        chart1.update();
    }
    if(chart2) {
        chart2.data.datasets[0].data = Array(maxPoints).fill(0);
        chart2.update();
    }
    if(chartComparison) {
        chartComparison.data.datasets[0].data = Array(maxPoints).fill(0);
        chartComparison.data.datasets[1].data = Array(maxPoints).fill(0);
        chartComparison.update();
    }
}

// Inicializar al cargar
window.addEventListener('load', initCharts);
</script>
</body>
</html>
